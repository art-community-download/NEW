<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIP Bonus | Part-Time Job</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* --- PREMIUM CSS --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; min-height: 100vh; background: linear-gradient(-45deg, #141e30, #243b55); color: white; padding: 20px; }
        
        .container { max-width: 500px; margin: 0 auto; padding-bottom: 50px; }

        /* Header */
        .header-top { display: flex; align-items: center; margin-bottom: 25px; }
        .back-btn { background: rgba(255,255,255,0.1); border: none; color: white; padding: 10px 14px; border-radius: 12px; cursor: pointer; margin-right: 15px; }
        h2 { font-size: 22px; font-weight: 600; color: #ffd700; text-shadow: 0 0 10px rgba(255, 215, 0, 0.5); }

        /* Progress Card */
        .vip-card {
            background: linear-gradient(135deg, #FFD700, #B8860B);
            border-radius: 20px; padding: 25px; text-align: center; color: #1a1a1a;
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.2); margin-bottom: 30px;
            position: relative; overflow: hidden; animation: slideDown 0.8s;
        }
        .vip-card::after {
            content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: rgba(255,255,255,0.2); transform: rotate(45deg); animation: shine 3s infinite;
        }
        @keyframes shine { 0% { left: -50%; } 100% { left: 150%; } }

        .vip-title { font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 2px; }
        .vip-score { font-size: 40px; font-weight: 800; margin: 10px 0; }
        .vip-info { font-size: 12px; font-weight: 600; }

        /* Reset Button (Hidden by default) */
        .reset-box { display: none; text-align: center; margin-bottom: 20px; animation: fadeIn 0.5s; }
        .btn-restart {
            background: #fff; color: #d32f2f; padding: 12px 25px; border-radius: 30px; border: none;
            font-weight: bold; cursor: pointer; box-shadow: 0 0 15px rgba(255,0,0,0.4);
        }

        /* Level List */
        .level-container { display: flex; flex-direction: column; gap: 15px; }

        .level-card {
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            padding: 15px; border-radius: 15px; display: flex; justify-content: space-between; align-items: center;
            transition: 0.3s;
        }
        
        .l-left h4 { font-size: 16px; color: #ffd700; margin-bottom: 4px; }
        .l-left p { font-size: 12px; opacity: 0.7; }
        
        .btn-claim {
            padding: 8px 15px; border-radius: 20px; border: none; font-size: 12px; font-weight: bold; cursor: pointer; transition: 0.3s;
        }
        
        /* Button States */
        .st-locked { background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.4); cursor: not-allowed; }
        .st-claim { background: #38ef7d; color: #1a1a1a; box-shadow: 0 0 10px #38ef7d; animation: pulse 1.5s infinite; }
        .st-done { background: #ffd700; color: #1a1a1a; cursor: default; }

        @keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Toast */
        .toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 5px; padding: 16px; position: fixed; z-index: 100; bottom: 30px; left: 50%; transform: translateX(-50%); }
        .toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }

    </style>
</head>
<body>

    <div class="container">
        <!-- Header -->
        <div class="header-top">
            <button class="back-btn" onclick="window.location.href='home.html'"><i class="fas fa-arrow-left"></i></button>
            <h2>VIP Bonus Area</h2>
        </div>

        <!-- Progress Card -->
        <div class="vip-card">
            <div class="vip-title"><i class="fas fa-crown"></i> Current Cycle Progress</div>
            <div class="vip-score"><span id="currScore">0</span> <span style="font-size:16px;">Active</span></div>
            <div class="vip-info">Cycle Level: <span id="cycleLvl">1</span></div>
        </div>

        <!-- Reset Button (Shows when all levels done) -->
        <div id="resetArea" class="reset-box">
            <p style="margin-bottom:10px; color:#38ef7d;">ðŸŽ‰ Congratulations! You completed all levels.</p>
            <button class="btn-restart" onclick="restartCycle()">Start New Cycle â†»</button>
        </div>

        <!-- Levels List -->
        <div id="level-list" class="level-container">
            <p style="text-align:center; opacity:0.5;">Loading Levels...</p>
        </div>

    </div>

    <div id="toast" class="toast">Message</div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, update, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDWu8H9uOVkHRXMbR4FFrzedZOh2wBkdJ0",
            authDomain: "art2-245f8.firebaseapp.com",
            databaseURL: "https://art2-245f8-default-rtdb.firebaseio.com",
            projectId: "art2-245f8",
            storageBucket: "art2-245f8.firebasestorage.app",
            messagingSenderId: "963842145655",
            appId: "1:963842145655:web:e7843407bec8528c67b572"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const uid = localStorage.getItem('currentUid');

        if(!uid) window.location.href = 'login_register.html';

        let activeRefCount = 0; // Total lifetime active referrals
        let vipDeduct = 0;      // Count to subtract (from previous cycles)
        let currentCycleScore = 0; // The actual score for this cycle
        let currentBalance = 0;
        let claimedList = [];   // Array of claimed level IDs
        let vipCycle = 1;

        // --- 1. GET ADMIN VIP SETTINGS ---
        // Default targets if admin hasn't set any
        let vipTargets = [
            { id: 1, target: 10, bonus: 500 },
            { id: 2, target: 20, bonus: 1200 },
            { id: 3, target: 30, bonus: 2000 }
        ];

        const settingsRef = ref(db, 'settings/vip_targets');
        onValue(settingsRef, (snapshot) => {
            const data = snapshot.val();
            if(data) {
                vipTargets = data; // Data should be an array like above
            }
            // After loading settings, update UI
            updateUI();
        });

        // --- 2. GET USER DATA ---
        const userRef = ref(db, 'users/' + uid);
        onValue(userRef, (snapshot) => {
            const user = snapshot.val();
            if(!user) return;

            currentBalance = parseFloat(user.balance || 0);
            vipDeduct = parseInt(user.vip_deduct_count || 0);
            claimedList = user.vip_claimed || [];
            vipCycle = user.vip_cycle || 1;

            document.getElementById('cycleLvl').innerText = vipCycle;
            
            // Calculate total active referrals from scratch (or store in user object)
            // For accuracy, we count again or use a stored counter
            countActiveReferrals();
        });

        function countActiveReferrals() {
            const allUsersRef = ref(db, 'users');
            onValue(allUsersRef, (snapshot) => {
                const users = snapshot.val();
                let count = 0;
                if(users) {
                    Object.values(users).forEach(u => {
                        if(u.referredBy === uid && u.isActive) {
                            count++;
                        }
                    });
                }
                activeRefCount = count;
                currentCycleScore = activeRefCount - vipDeduct; // IMPORTANT LOGIC
                if(currentCycleScore < 0) currentCycleScore = 0; // Safety

                document.getElementById('currScore').innerText = currentCycleScore;
                
                updateUI();
            }, { onlyOnce: true });
        }

        // --- 3. RENDER UI ---
        function updateUI() {
            const list = document.getElementById('level-list');
            list.innerHTML = "";
            let allClaimed = true;

            vipTargets.forEach((level, index) => {
                const isClaimed = claimedList.includes(level.id);
                const isUnlocked = currentCycleScore >= level.target;
                
                if(!isClaimed) allClaimed = false;

                let btnHTML = '';
                if (isClaimed) {
                    btnHTML = `<button class="btn-claim st-done">Received âœ…</button>`;
                } else if (isUnlocked) {
                    btnHTML = `<button class="btn-claim st-claim" onclick="claimBonus(${index})">Claim à§³${level.bonus}</button>`;
                } else {
                    btnHTML = `<button class="btn-claim st-locked"><i class="fas fa-lock"></i> ${level.target} Active</button>`;
                }

                list.innerHTML += `
                    <div class="level-card">
                        <div class="l-left">
                            <h4>Target: ${level.target} Active</h4>
                            <p>Reward: à§³${level.bonus}</p>
                        </div>
                        <div class="l-right">
                            ${btnHTML}
                        </div>
                    </div>
                `;
            });

            // Show Reset Button if all levels are claimed
            if(allClaimed && vipTargets.length > 0) {
                document.getElementById('resetArea').style.display = 'block';
            } else {
                document.getElementById('resetArea').style.display = 'none';
            }
        }

        // --- 4. ACTIONS ---
        
        // Claim Function
        window.claimBonus = function(index) {
            const level = vipTargets[index];
            
            // Security check
            if(currentCycleScore < level.target) return showToast("Target not reached!", "red");
            if(claimedList.includes(level.id)) return showToast("Already claimed!", "orange");

            // Update User
            let newClaimed = [...claimedList, level.id];
            let newBal = currentBalance + parseInt(level.bonus);

            update(userRef, {
                balance: newBal,
                vip_claimed: newClaimed
            }).then(() => {
                showToast(`Congrats! à§³${level.bonus} Added`, "green");
                // Animation or sound could be added here
            }).catch(err => showToast("Error!", "red"));
        };

        // Restart Cycle Function
        window.restartCycle = function() {
            if(!confirm("Start a new cycle? Your current progress will reset for new rewards.")) return;

            // Logic:
            // 1. vip_deduct_count becomes current total active referrals
            // 2. vip_claimed list is cleared
            // 3. vip_cycle increases by 1

            update(userRef, {
                vip_deduct_count: activeRefCount,
                vip_claimed: [], // Empty list
                vip_cycle: vipCycle + 1
            }).then(() => {
                showToast("New Cycle Started! ðŸš€", "#00c6ff");
                window.location.reload(); // Refresh to reset UI logic cleanly
            });
        };

        // Utils
        window.showToast = function(msg, color="#333") {
            const x = document.getElementById("toast");
            x.innerText = msg;
            x.style.backgroundColor = color;
            x.className = "toast show";
            setTimeout(() => { x.className = x.className.replace("toast show", "toast"); }, 3000);
        };
    </script>
</body>
</html>
