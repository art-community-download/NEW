<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Team | Part-Time Job</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* --- PREMIUM CSS --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; min-height: 100vh; background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab); background-size: 400% 400%; animation: gradientBG 15s ease infinite; padding: 20px; color: white; }
        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        
        .container { max-width: 500px; margin: 0 auto; padding-bottom: 50px; }

        .header-top { display: flex; align-items: center; margin-bottom: 20px; }
        .back-btn { background: rgba(255,255,255,0.2); border: none; color: white; padding: 10px 14px; border-radius: 12px; cursor: pointer; margin-right: 15px; }
        h2 { font-size: 22px; font-weight: 600; }

        /* Referral Card */
        .ref-card { background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.2); border-radius: 20px; padding: 20px; text-align: center; margin-bottom: 20px; backdrop-filter: blur(10px); }
        .code-display { font-size: 24px; font-weight: bold; color: #ffd700; letter-spacing: 2px; margin: 10px 0; cursor: pointer; text-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        
        /* Stats */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; }
        .stat-box { background: rgba(0,0,0,0.2); padding: 15px; border-radius: 15px; text-align: center; }
        .stat-val { font-size: 22px; font-weight: bold; }
        .stat-lbl { font-size: 11px; opacity: 0.8; }

        /* Tabs */
        .tab-menu { display: flex; justify-content: space-between; background: rgba(255,255,255,0.1); border-radius: 30px; padding: 5px; margin-bottom: 20px; }
        .tab-btn { flex: 1; padding: 8px 0; border: none; background: transparent; color: white; border-radius: 25px; font-size: 12px; font-weight: 600; cursor: pointer; transition: 0.3s; }
        .tab-active { background: white; color: #333; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }

        /* Member List */
        .list-view { display: none; animation: fadeIn 0.5s; }
        .list-active { display: block; }
        
        .member-card { background: rgba(255,255,255,0.1); margin-bottom: 10px; padding: 15px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; border-left: 5px solid #ccc; position: relative; overflow: hidden; }
        
        /* Status Styles */
        .b-active { border-left-color: #00b09b; background: rgba(0, 176, 155, 0.1); }
        .b-pending { border-left-color: #ff416c; background: rgba(255, 65, 108, 0.1); }

        .m-info h4 { font-size: 15px; margin-bottom: 4px; }
        .m-info p { font-size: 11px; opacity: 0.7; }
        
        .profit-badge { font-size: 10px; padding: 4px 8px; border-radius: 8px; font-weight: bold; margin-top: 5px; display: inline-block; }
        .p-yes { background: #00b09b; color: white; }
        .p-no { background: #ff416c; color: white; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 5px; padding: 16px; position: fixed; z-index: 100; bottom: 30px; left: 50%; transform: translateX(-50%); }
        .toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
    </style>
</head>
<body>

    <div class="container">
        <div class="header-top">
            <button class="back-btn" onclick="window.location.href='home.html'"><i class="fas fa-arrow-left"></i></button>
            <h2>My Team</h2>
        </div>

        <!-- Refer Info -->
        <div class="ref-card">
            <p style="font-size:12px;">Your Invite Code</p>
            <div class="code-display" id="myRefCode" onclick="copyCode()">...</div>
            <p style="font-size:10px; opacity:0.7;">(Tap code to copy)</p>
        </div>

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-box">
                <div class="stat-val" id="totalM">0</div>
                <div class="stat-lbl">Total Team</div>
            </div>
            <div class="stat-box">
                <div class="stat-val" id="activeM" style="color:#00b09b;">0</div>
                <div class="stat-lbl">Active Users</div>
            </div>
        </div>

        <!-- 3 Level Tabs -->
        <div class="tab-menu">
            <button class="tab-btn tab-active" onclick="showTab('l1', this)">Level 1</button>
            <button class="tab-btn" onclick="showTab('l2', this)">Level 2</button>
            <button class="tab-btn" onclick="showTab('l3', this)">Level 3</button>
        </div>

        <!-- Member Lists -->
        <div id="list-l1" class="list-view list-active">Loading...</div>
        <div id="list-l2" class="list-view">Loading...</div>
        <div id="list-l3" class="list-view">Loading...</div>

    </div>
    <div id="toast" class="toast">Code Copied!</div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDWu8H9uOVkHRXMbR4FFrzedZOh2wBkdJ0",
            authDomain: "art2-245f8.firebaseapp.com",
            databaseURL: "https://art2-245f8-default-rtdb.firebaseio.com",
            projectId: "art2-245f8",
            storageBucket: "art2-245f8.firebasestorage.app",
            messagingSenderId: "963842145655",
            appId: "1:963842145655:web:e7843407bec8528c67b572"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const uid = localStorage.getItem('currentUid');

        if(!uid) window.location.href = 'login_register.html';
        document.getElementById('myRefCode').innerText = uid;

        // --- TEAM CALCULATION LOGIC ---
        const usersRef = ref(db, 'users');
        onValue(usersRef, (snapshot) => {
            const users = snapshot.val();
            if(!users) return;

            let lvl1 = [], lvl2 = [], lvl3 = [];
            let activeCount = 0;

            // 1. Find Level 1 (Direct)
            Object.values(users).forEach(u => {
                if(u.referredBy === uid) {
                    lvl1.push(u);
                    if(u.isActive) activeCount++;
                }
            });

            // 2. Find Level 2 (Downline of L1)
            const l1_ids = lvl1.map(u => u.uid);
            Object.values(users).forEach(u => {
                if(l1_ids.includes(u.referredBy)) {
                    lvl2.push(u);
                    if(u.isActive) activeCount++;
                }
            });

            // 3. Find Level 3 (Downline of L2)
            const l2_ids = lvl2.map(u => u.uid);
            Object.values(users).forEach(u => {
                if(l2_ids.includes(u.referredBy)) {
                    lvl3.push(u);
                    if(u.isActive) activeCount++;
                }
            });

            // Update Stats
            document.getElementById('totalM').innerText = lvl1.length + lvl2.length + lvl3.length;
            document.getElementById('activeM').innerText = activeCount;

            // Render
            renderList('list-l1', lvl1, 'Direct');
            renderList('list-l2', lvl2, 'Team');
            renderList('list-l3', lvl3, 'Team');
        });

        function renderList(id, data, type) {
            const el = document.getElementById(id);
            el.innerHTML = "";
            
            if(data.length === 0) {
                el.innerHTML = `<p style="text-align:center; opacity:0.5; margin-top:20px;">No members found.</p>`;
                return;
            }

            data.forEach(m => {
                // Logic: Active hole profit pabe, pending hole pabe na
                const isAct = m.isActive;
                const statusClass = isAct ? 'b-active' : 'b-pending';
                const profitBadge = isAct ? '<span class="profit-badge p-yes">Profit Added ✅</span>' : '<span class="profit-badge p-no">No Profit (Pending) ❌</span>';
                
                el.innerHTML += `
                    <div class="member-card ${statusClass}">
                        <div class="m-info">
                            <h4>${m.fname} ${m.lname}</h4>
                            <p>UID: ${m.uid}</p>
                            <p>Joined: ${m.joinDate || 'N/A'}</p>
                            ${profitBadge}
                        </div>
                        <div style="text-align:right;">
                            <i class="fas ${isAct ? 'fa-check-circle' : 'fa-clock'}" style="color:${isAct?'#00b09b':'#ff416c'}; font-size:20px;"></i>
                        </div>
                    </div>
                `;
            });
        }

        // --- TABS & UTILS ---
        window.showTab = function(tid, btn) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('tab-active'));
            btn.classList.add('tab-active');
            
            document.querySelectorAll('.list-view').forEach(d => d.classList.remove('list-active'));
            document.getElementById('list-'+tid).classList.add('list-active');
        }

        window.copyCode = function() {
            navigator.clipboard.writeText(uid).then(() => {
                const t = document.getElementById('toast');
                t.className = "toast show";
                setTimeout(() => t.className = t.className.replace("show",""), 2000);
            });
        }
    </script>
</body>
</html>
